USE master;
DROP DATABASE IF EXISTS db01;
GO

CREATE DATABASE [db01]
 CONTAINMENT = NONE
 ON  PRIMARY 
( NAME = N'db01', FILENAME = N'C:\SQLData\db01.mdf' , SIZE = 8192KB , FILEGROWTH = 65536KB ), 
 FILEGROUP [YR_2006] 
( NAME = N'db01_2006', FILENAME = N'C:\SQLData\db01_2006.ndf' , SIZE = 8192KB , FILEGROWTH = 4096KB ), 
 FILEGROUP [YR_2007] 
( NAME = N'db01_2007', FILENAME = N'C:\SQLData\db01_2007.ndf' , SIZE = 8192KB , FILEGROWTH = 4096KB ), 
 FILEGROUP [YR_2008] 
( NAME = N'db01_2008', FILENAME = N'C:\SQLData\db01_2008.ndf' , SIZE = 8192KB , FILEGROWTH = 4096KB ), 
 FILEGROUP [YR_BEFORE] 
( NAME = N'db01_before', FILENAME = N'C:\SQLData\db01_before.ndf' , SIZE = 8192KB , FILEGROWTH = 4096KB )
 LOG ON 
( NAME = N'db01_log', FILENAME = N'C:\SQLData\db01_log.ldf' , SIZE = 8192KB , FILEGROWTH = 65536KB )
GO
USE db01;
GO

CREATE TABLE dbo.BigOrder
(
order_id int CONSTRAINT PK_BigOrder PRIMARY KEY IDENTITY(1, 1),
order_date date,
big_data nchar(4000)
);

USE [db01]
GO
BEGIN TRANSACTION
CREATE PARTITION FUNCTION [fnPart](date) AS RANGE RIGHT 
FOR VALUES (N'2006-01-01', N'2007-01-01', N'2008-01-01')

CREATE PARTITION SCHEME [schPart] AS PARTITION [fnPart] 
TO ([YR_BEFORE], [YR_2006], [YR_2007], [YR_2008])

ALTER TABLE [dbo].[BigOrder] DROP CONSTRAINT [PK_BigOrder] WITH ( ONLINE = OFF )

ALTER TABLE [dbo].[BigOrder] ADD  CONSTRAINT [PK_BigOrder] PRIMARY KEY NONCLUSTERED 
(
	[order_id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) 
ON [PRIMARY]


CREATE CLUSTERED INDEX [ClusteredIndex_on_schPart_638440213063794325] ON [dbo].[BigOrder]
(
	[order_date]
)WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF) 
ON [schPart]([order_date])

DROP INDEX [ClusteredIndex_on_schPart_638440213063794325] ON [dbo].[BigOrder]

COMMIT TRANSACTION


INSERT INTO dbo.BigOrder(order_date) VALUES('2005-1-1');
GO 4096

INSERT INTO dbo.BigOrder(order_date) VALUES('2006-1-1');
GO 8192

INSERT INTO dbo.BigOrder(order_date) VALUES('2008-1-1');
GO 2048

UPDATE dbo.BigOrder
SET order_date = '2007-1-1'
WHERE order_date = '2006-1-1';
GO

DBCC SHRINKDATABASE(N'db01' )
GO

----------SPLIT
USE [master]
GO
ALTER DATABASE [db01] ADD FILEGROUP [YR_2009]
ALTER DATABASE [db01] ADD FILE ( NAME = N'db01_2009', FILENAME = N'C:\SQLData\db01_2009.ndf' , SIZE = 8192KB , FILEGROWTH = 65536KB ) TO FILEGROUP [YR_2009]
GO

USE db01;
GO
ALTER PARTITION SCHEME schPart NEXT USED YR_2009;
ALTER PARTITION FUNCTION fnPart() SPLIT RANGE('2009-1-1');
GO


INSERT INTO dbo.BigOrder(order_date) VALUES('2009-1-1');
GO 8192

-----------MERGE

UPDATE dbo.BigOrder
SET order_date = '2006-1-1'
WHERE order_date = '2007-1-1';
GO


ALTER PARTITION FUNCTION fnPart() MERGE RANGE('2006-1-1');


INSERT INTO dbo.BigOrder(order_date) VALUES('2006-1-1');
GO 8192
GO

USE [db01]
ALTER DATABASE [db01]  REMOVE FILE [db01_2006]
ALTER DATABASE [db01] REMOVE FILEGROUP [YR_2006]
GO
